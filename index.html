<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>房产备忘录离线版v1.0</title>
    <script src="libs/tailwindcss.js"></script>
    <script>
        if (typeof tailwind === 'undefined') {
            document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
        }
    </script>
    <link href="libs/fontawesome/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"
        media="print" onload="this.media='all'" onerror="this.onerror=null;">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            overscroll-behavior: none;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f172a;
            /* Slate 950 */
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .thin-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .thin-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .thin-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 2px;
        }

        .thin-scrollbar:hover::-webkit-scrollbar-thumb {
            background: #6b7280;
        }

        #map-viewport {
            background-color: #1a1a1a;
            background-image:
                linear-gradient(#262626 1px, transparent 1px),
                linear-gradient(90deg, #262626 1px, transparent 1px);
            background-size: 256px 256px;
            overflow: hidden;
            width: 100%;
            height: 100%;
            touch-action: none;
            cursor: grab;
        }

        #map-viewport:active {
            cursor: grabbing;
        }

        #map-world {
            position: absolute;
            transform-origin: 0 0;
            /* 移除 will-change 避免过度缓存 */
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .map-tile {
            position: absolute;
            width: 256px;
            height: 256px;
            pointer-events: none;
        }

        .map-tile img {
            width: 100%;
            height: 100%;
            display: block;
            pointer-events: none;
            /* 略微放大消除瓦片间缝隙，同时保持GPU层优化 */
            transform: translateZ(0) scale(1.005);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .marker {
            z-index: 50;
            position: absolute;
            width: 0;
            height: 0;
            transform: scale(calc(1 / var(--map-scale, 1)));
            transform-origin: 0 0;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .marker-icon {
            transform: translate(-50%, -100%);
            position: relative;
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @media (hover: hover) {
            .marker:hover {
                z-index: 1000 !important;
            }

            .marker:hover .marker-icon {
                transform: translate(-50%, -100%) scale(1.2);
            }
        }

        /* 预览框 */
        .marker-preview-box {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 100px;
            border: 2px solid #facc15;
            border-radius: 6px;
            background-color: #1f2937;
            margin-bottom: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            z-index: 100;
            overflow: hidden;
        }

        :root {
            /* 现代深色模式变量: Ultra Modern Glass */
            --glass-bg: rgba(15, 23, 42, 0.65);
            --glass-bg-solid: rgba(15, 23, 42, 0.85);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-border-accent: rgba(234, 179, 8, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05);
            --glass-glow: 0 0 40px rgba(234, 179, 8, 0.1);
            --accent-color: #eab308;
            --accent-gradient: linear-gradient(135deg, #eab308 0%, #f59e0b 100%);
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --blur-strength: 20px;
            --blur-strength-heavy: 30px;
        }

        .marker-preview-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .marker-preview-box::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #facc15 transparent transparent transparent;
        }

        @media (hover: hover) {
            .marker:hover .marker-preview-box {
                display: block;
                animation: fadeIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
        }

        .marker:active .marker-preview-box {
            display: block;
            animation: fadeIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* 侧边栏 (默认隐藏) */
        #sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            width: 320px;
            z-index: 40;
            display: flex;
            flex-direction: column;
            background: var(--glass-bg-solid);
            backdrop-filter: blur(var(--blur-strength-heavy));
            -webkit-backdrop-filter: blur(var(--blur-strength-heavy));
            border-right: 1px solid var(--glass-border);
            transform: translateX(-100%);
            /* 默认隐藏 */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--glass-shadow);
        }

        #sidebar.open {
            transform: translateX(0);
        }

        /* 顶部栏 (默认隐藏) */
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            z-index: 45;
            /* 比侧边栏高一点，或者通过互斥逻辑控制 */
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-strength));
            -webkit-backdrop-filter: blur(var(--blur-strength));
            border-bottom: 1px solid var(--glass-border);
            transform: translateY(-100%);
            /* 默认隐藏 */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            box-shadow: var(--glass-shadow);
        }

        #top-bar.open {
            transform: translateY(0);
        }

        /* 感应区 - 调整：顶部感应区变宽 */
        #trigger-left {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 15px;
            z-index: 35;
        }

        #trigger-top {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 35px;
            z-index: 35;
        }

        /* 增加到35px */

        /* 搜索框 (融入侧边栏) - 始终展开状态 */
        #search-widget {
            position: relative;
            z-index: 55;
            display: flex;
            align-items: center;
        }

        /* 删除了宽度拖拽手柄 CSS */

        /* 高度拖拽手柄 (中间) */
        #sidebar-vertical-resizer {
            height: 6px;
            background-color: #111827;
            border-top: 1px solid #374151;
            border-bottom: 1px solid #374151;
            cursor: row-resize;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        #sidebar-vertical-resizer:hover,
        #sidebar-vertical-resizer.resizing {
            background-color: #eab308;
        }

        #sidebar-vertical-resizer::after {
            content: '';
            width: 30px;
            height: 2px;
            background-color: #4b5563;
            border-radius: 1px;
        }

        .gallery-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .gallery-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 2px;
        }

        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }

        .color-dot.selected {
            border-color: white;
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .filter-color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .filter-color-dot.active {
            border-color: white;
            transform: scale(1.1);
        }

        .filter-color-dot:not(.active) {
            opacity: 0.3;
            transform: scale(0.9);
        }

        .filter-checkbox:checked {
            background-color: #eab308;
            border-color: #eab308;
        }

        .batch-checkbox {
            display: none;
        }

        .batch-mode .batch-checkbox {
            display: block;
        }

        .batch-mode .list-content {
            padding-left: 0.5rem;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            #map-viewport {
                padding-top: 56px;
            }

            /* Push map down for top bar */
            .marker-preview-box {
                display: none !important;
            }

            /* Sidebar becomes Bottom Drawer */
            #sidebar {
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 85vh;
                /* Max height for drawer */
                transform: translateY(100%);
                /* Slide down to hide */
                border-right: none;
                border-top: 1px solid var(--glass-border-accent);
                border-radius: 20px 20px 0 0;
                z-index: 60 !important;
                box-shadow: 0 -8px 40px rgba(0, 0, 0, 0.6), var(--glass-glow);
                transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
            }

            #sidebar.open {
                transform: translateY(0);
            }

            /* Hide triggers on mobile */
            #trigger-left,
            #trigger-top {
                display: none;
            }

            /* Adjust filter section height in drawer - 增加时间/批次栏高度 */
            #sidebar-filter-section {
                height: auto !important;
                flex: 1;
                min-height: 180px;
            }

            /* 增加时间/批次容器高度 */
            #date-filters-container {
                min-height: 120px;
                max-height: 200px;
            }

            /* 移动端禁用 backdrop-filter 以避免渲染问题 */
            #sidebar {
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                background: rgba(15, 23, 42, 0.98) !important;
            }

            #mobile-top-bar {
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                background: rgba(15, 23, 42, 0.98) !important;
            }

            #sidebar-overlay {
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }

            /* Hide vertical resizer on mobile */
            #sidebar-vertical-resizer {
                display: none;
            }
        }
    </style>
</head>

<body class="flex flex-col h-screen w-screen overflow-hidden">

    <!-- Loading -->
    <div id="loading-mask"
        class="fixed inset-0 bg-[#0f172a] z-[100] flex flex-col justify-center items-center transition-opacity duration-500">
        <i class="fa-solid fa-compass fa-spin text-4xl text-yellow-500 mb-4"></i>
        <p class="text-gray-400 text-sm">正在加载...</p>
        <p class="text-gray-600 text-xs mt-2" id="loading-text">Glass UI v5.2 (Ultra Modern)</p>
    </div>

    <!-- Mobile Top Bar (Fixed) - Modern Glass UI -->
    <div id="mobile-top-bar"
        class="md:hidden fixed top-0 left-0 right-0 h-14 z-40 flex items-center justify-between px-4 transition-transform duration-300"
        style="background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.12); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);">
        <button onclick="app.toggleSidebar(true)"
            class="text-yellow-500 text-lg w-10 h-10 flex items-center justify-center active:scale-95 transition-transform">
            <i class="fa-solid fa-bars"></i>
        </button>
        <div class="font-bold text-gray-200 flex items-center gap-2">
            <i class="fa-solid fa-map-location-dot text-yellow-500"></i>
            <span>房产备忘</span>
        </div>
        <div class="flex items-center gap-4 justify-end">
            <button onclick="app.exportData()" class="text-gray-400 hover:text-white" title="备份">
                <i class="fa-solid fa-download"></i>
            </button>
            <button onclick="document.getElementById('file-import').click()" class="text-gray-400 hover:text-white"
                title="恢复">
                <i class="fa-solid fa-upload"></i>
            </button>
            <button onclick="app.openTemplateManager()" class="text-gray-400 hover:text-white" title="设置">
                <i class="fa-solid fa-cog"></i>
            </button>
        </div>
    </div>

    <!-- 感应区 (Top 宽松版) -->
    <div id="trigger-top"></div>
    <div id="trigger-left"></div>

    <!-- 移动端侧边栏遮罩 - 增强毛玻璃效果 -->
    <div id="sidebar-overlay" onclick="app.toggleSidebar(false)"
        class="fixed inset-0 z-50 hidden transition-opacity duration-300 opacity-0 md:hidden"
        style="background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);">
    </div>

    <!-- 顶部栏 (Map, Template, Backup, Search) -->
    <div id="top-bar">
        <!-- 左侧: 标题和地图选择 -->
        <div class="flex items-center gap-4 flex-shrink-0">
            <div class="text-yellow-500 font-bold text-lg flex items-center">
                <i class="fa-solid fa-map-location-dot mr-2"></i>
                <span class="text-sm text-gray-300 hidden sm:inline">房产备忘录</span>
            </div>

            <select id="map-select"
                class="bg-gray-800 border border-gray-600 rounded px-3 py-1.5 text-sm text-white focus:outline-none focus:border-yellow-500 hover:bg-gray-700 transition-colors">
                <option value="qinghe">清河</option>
                <option value="kaifeng">开封</option>
                <option value="hexi">河西</option>
                <option value="bujianshan">不见山</option>
                <option value="hutuo">滹沱</option>
            </select>
        </div>

        <!-- 右侧: 功能区 (模板, 备份, 搜索) -->
        <div class="flex items-center gap-3">

            <!-- 模板切换器 -->
            <div class="flex gap-1 items-center bg-gray-800 px-2 py-1 rounded border border-gray-600">
                <i class="fa-solid fa-save text-gray-500 text-xs"></i>
                <select id="template-select"
                    class="bg-transparent text-xs text-white outline-none border-none py-1 w-20 sm:w-24"
                    onchange="app.switchTemplate(this.value)">
                    <!-- JS 填充 -->
                </select>
                <button onclick="app.openTemplateManager()" class="text-gray-400 hover:text-white ml-1">
                    <i class="fa-solid fa-cog"></i>
                </button>
            </div>

            <!-- 备份恢复 -->
            <div class="flex gap-2">
                <!-- 备份下拉菜单 -->
                <div class="relative group">
                    <button
                        class="bg-gray-800 hover:bg-gray-700 text-xs px-3 py-1.5 rounded border border-gray-600 text-gray-300 transition-colors flex items-center gap-1">
                        <i class="fa-solid fa-download"></i><span class="hidden sm:inline">备份</span>
                        <i class="fa-solid fa-caret-down text-[10px] ml-1"></i>
                    </button>
                    <div
                        class="absolute top-full left-0 mt-1 bg-gray-800 border border-gray-600 rounded shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50 min-w-[120px]">
                        <button onclick="app.exportData(true)"
                            class="block w-full text-left px-3 py-2 text-xs text-gray-300 hover:bg-gray-700 hover:text-white">
                            <i class="fa-solid fa-image mr-2"></i>完整备份
                        </button>
                        <button onclick="app.exportData(false)"
                            class="block w-full text-left px-3 py-2 text-xs text-gray-300 hover:bg-gray-700 hover:text-white border-t border-gray-700">
                            <i class="fa-regular fa-file mr-2"></i>无图备份
                        </button>
                    </div>
                </div>
                <button onclick="document.getElementById('file-import').click()"
                    class="bg-gray-800 hover:bg-gray-700 text-xs px-3 py-1.5 rounded border border-gray-600 text-gray-300 transition-colors">
                    <i class="fa-solid fa-upload sm:mr-1"></i><span class="hidden sm:inline">恢复</span>
                </button>
                <input type="file" id="file-import" class="hidden" accept=".json" onchange="app.initImport(this)">
            </div>

        </div>
    </div>

    <!-- 侧边栏 (Filters, List, Undo, Batch) -->
    <div id="sidebar">
        <!-- 移除了宽度拖拽手柄 -->

        <!-- 头部操作区 -->
        <div class="p-3 bg-gray-900 border-b border-gray-700 flex-shrink-0 flex justify-between items-center">
            <div class="text-xs text-gray-400 font-bold">操作面板</div>
            <div class="flex gap-2">
                <button onclick="app.undo()" id="undo-btn"
                    class="text-xs bg-gray-800 hover:bg-gray-700 border border-gray-600 text-gray-300 px-2 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-rotate-left mr-1"></i>撤回
                </button>
                <button onclick="app.toggleBatchMode()" id="batch-btn"
                    class="text-xs bg-gray-800 hover:bg-gray-700 border border-gray-600 text-gray-300 px-2 py-1 rounded">
                    批量
                </button>
            </div>
        </div>

        <!-- 筛选器区域 (可变高度) -->
        <div class="bg-gray-800 p-3 flex-shrink-0 flex flex-col min-h-[100px]" id="sidebar-filter-section"
            style="height: 320px;">
            <!-- 搜索挂件 -->
            <div id="search-widget"
                class="mb-3 flex-shrink-0 flex items-center gap-2 bg-gray-900 rounded border border-gray-700 px-2 py-1.5">
                <button id="search-toggle" onclick="app.toggleSearch()"
                    class="text-yellow-500 hover:text-white flex-shrink-0 cursor-pointer text-sm">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
                <input type="text" id="search-input" placeholder="搜索..."
                    class="flex-1 bg-transparent text-xs text-white focus:outline-none placeholder-gray-500">
                <select id="search-scope"
                    class="bg-gray-800 border border-gray-600 text-[10px] rounded px-1 text-gray-300 focus:outline-none h-5 flex-shrink-0">
                    <option value="local">当前</option>
                    <option value="global">全局</option>
                </select>
            </div>

            <!-- 状态筛选 & 收藏筛选 -->
            <div class="mb-2 flex-shrink-0">
                <div class="text-[10px] uppercase text-gray-500 font-bold mb-1.5 flex justify-between items-center">
                    <span>状态 / 收藏</span>
                    <button id="filter-favorites-btn" onclick="app.toggleFavoriteFilter()"
                        class="text-[10px] px-2 py-0.5 rounded border border-gray-600 bg-gray-700 text-gray-400 hover:text-yellow-400 hover:border-yellow-500/50 flex items-center gap-1 transition-colors">
                        <i class="fa-solid fa-star text-[9px]"></i> 只看收藏
                    </button>
                </div>
                <div class="flex gap-2 text-xs" id="status-filters"></div>
            </div>

            <!-- 颜色筛选 & 聚合开关 -->
            <div class="mb-2 flex-shrink-0">
                <div class="text-[10px] uppercase text-gray-500 font-bold mb-1.5 flex justify-between items-center">
                    <span>颜色筛选</span>
                    <button id="cluster-toggle-btn" onclick="app.toggleClustering()"
                        class="text-[10px] px-2 py-0.5 rounded border border-gray-600 bg-gray-700 text-gray-400 hover:text-yellow-400 hover:border-yellow-500/50 flex items-center gap-1 transition-colors">
                        <i class="fa-solid fa-layer-group text-[9px]"></i> 聚合
                    </button>
                </div>
                <div class="flex gap-2 items-center flex-wrap" id="color-filters"></div>
            </div>

            <!-- 时间筛选 -->
            <div class="flex-1 flex flex-col min-h-0">
                <div
                    class="text-[10px] uppercase text-gray-500 font-bold mb-1.5 flex justify-between items-center flex-shrink-0">
                    <span id="date-filter-title">时间/批次</span>
                    <div class="flex gap-1">
                        <button onclick="app.selectAllDates()"
                            class="text-yellow-500 hover:text-yellow-400 text-[10px] px-2 py-0.5 border border-yellow-500/30 rounded"
                            title="全选/全不选">全选</button>
                        <button onclick="app.invertDates()"
                            class="text-gray-400 hover:text-gray-300 text-[10px] px-2 py-0.5 border border-gray-600 rounded"
                            title="反转">反选</button>
                    </div>
                </div>
                <div class="bg-gray-900 rounded border border-gray-700 overflow-y-auto thin-scrollbar p-1 flex-1"
                    id="date-filters-container">
                    <div class="flex flex-col gap-0.5" id="date-filters"></div>
                </div>
            </div>
        </div>

        <!-- 高度拖拽手柄 -->
        <div id="sidebar-vertical-resizer" title="上下拖动调整筛选区高度"></div>

        <!-- 列表内容 -->
        <div class="flex-1 overflow-y-auto p-2 space-y-1.5 bg-gray-800 thin-scrollbar" id="marker-list"></div>

        <!-- 底部计数/操作栏 -->
        <div class="p-2 bg-gray-900 border-t border-gray-700 text-[10px] text-gray-500 flex justify-between items-center flex-shrink-0"
            id="bottom-bar">
            <!-- 默认显示 -->
            <div id="default-bottom-content" class="flex justify-between w-full items-center">
                <span id="marker-count" class="mr-2">...</span>
                <div class="flex gap-2">
                    <button onclick="app.clearCurrentMapMarkers()"
                        class="text-red-400 bg-red-900/10 px-2 py-0.5 rounded hover:bg-red-900/30 border border-red-900/20">清空当前</button>
                    <button onclick="app.clearAllMapMarkers()"
                        class="text-gray-500 hover:text-red-400 px-2 py-0.5 rounded hover:bg-gray-800">清空全局</button>
                </div>
            </div>
            <!-- 批量操作显示 -->
            <div id="batch-bottom-content" class="hidden flex-col w-full gap-2">
                <div class="flex gap-1 items-center justify-between text-white">
                    <div class="flex items-center gap-1">
                        <span>选: <span id="batch-count" class="text-yellow-500 font-bold mr-1">0</span></span>
                        <button onclick="app.selectAllBatch()"
                            class="text-xs bg-gray-700 hover:bg-gray-600 px-1.5 py-0.5 rounded border border-gray-600 text-white"
                            title="全选/全不选">全</button>
                        <button onclick="app.invertBatchSelection()"
                            class="text-xs bg-gray-700 hover:bg-gray-600 px-1.5 py-0.5 rounded border border-gray-600 text-white"
                            title="反转">反</button>
                        <button onclick="app.exportBatchSelection()"
                            class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-0.5 rounded border border-gray-600 text-white ml-1"><i
                                class="fa-solid fa-file-export"></i></button>
                        <button onclick="app.deleteBatchSelection()"
                            class="text-xs bg-red-900/50 hover:bg-red-800 text-red-300 px-2 py-0.5 rounded border border-red-800"><i
                                class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                <div class="flex gap-1">
                    <select id="batch-status"
                        class="bg-gray-800 border border-gray-600 rounded text-white text-[10px] px-1 py-1 flex-1">
                        <option value="">状态...</option>
                        <option value="existing">已有</option>
                        <option value="built">已建</option>
                        <option value="missing">未有</option>
                    </select>
                    <select id="batch-color"
                        class="bg-gray-800 border border-gray-600 rounded text-white text-[10px] px-1 py-1 flex-1">
                        <option value="">颜色...</option>
                        <option value="red">红</option>
                        <option value="blue">蓝</option>
                        <option value="green">绿</option>
                        <option value="yellow">黄</option>
                        <option value="cyan">青</option>
                        <option value="purple">紫</option>
                        <option value="orange">橙</option>
                        <option value="pink">粉</option>
                    </select>
                    <button onclick="app.executeBatchUpdate()"
                        class="bg-yellow-600 text-white px-2 rounded hover:bg-yellow-500">应用</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 地图 -->
    <div class="flex-1 relative h-full bg-black overflow-hidden" id="map-root">
        <div id="map-viewport">
            <div id="map-world">
                <div id="tiles-layer" class="absolute inset-0 z-0"></div>
                <div id="markers-layer" class="absolute inset-0 z-10 pointer-events-none"></div>
            </div>
        </div>
    </div>

    <!-- 导入设置模态框 -->
    <div id="import-modal"
        class="fixed inset-0 bg-black/80 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-sm border border-gray-700 flex flex-col">
            <div class="p-3 border-b border-gray-700 bg-gray-900 rounded-t-lg">
                <h3 class="font-bold text-white text-sm">导入选项</h3>
            </div>
            <div class="p-4 space-y-4">
                <div class="text-sm text-gray-300">
                    检测到 <span id="import-new-count" class="text-yellow-500 font-bold">0</span> 条新数据。
                    <br>
                    <span class="text-gray-500 text-xs">已有ID的数据将被跳过。导入的数据将存入当前模板。</span>
                </div>

                <div class="space-y-3 p-3 bg-gray-900/50 rounded border border-gray-700">
                    <p class="text-xs text-gray-400 font-bold mb-2">为新数据设置属性:</p>

                    <div class="flex items-center justify-between">
                        <label class="text-xs text-gray-300">状态</label>
                        <select id="import-status"
                            class="bg-gray-800 border border-gray-600 rounded text-white text-xs px-2 py-1 outline-none focus:border-yellow-500 w-32">
                            <option value="" class="font-bold text-yellow-500">★ 保留原设置</option>
                            <option value="missing" selected>强制设为：未有</option>
                            <option value="existing">强制设为：已有</option>
                            <option value="built">强制设为：已建</option>
                        </select>
                    </div>

                    <div class="flex items-center justify-between">
                        <label class="text-xs text-gray-300">颜色</label>
                        <select id="import-color"
                            class="bg-gray-800 border border-gray-600 rounded text-white text-xs px-2 py-1 outline-none focus:border-yellow-500 w-32">
                            <option value="" class="font-bold text-yellow-500">★ 保留原设置</option>
                            <option value="blue" selected>强制设为：蓝色</option>
                            <option value="red">强制设为：红色</option>
                            <option value="green">强制设为：绿色</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="p-3 border-t border-gray-700 flex justify-end gap-2 bg-gray-900 rounded-b-lg">
                <button onclick="document.getElementById('import-modal').classList.add('hidden')"
                    class="px-3 py-1.5 text-xs text-gray-400 hover:text-white">取消</button>
                <button onclick="app.confirmImport()"
                    class="px-4 py-1.5 text-xs bg-yellow-600 hover:bg-yellow-500 text-white rounded font-bold">确认导入</button>
            </div>
        </div>
    </div>

    <!-- 模板管理模态框 -->
    <div id="template-modal"
        class="fixed inset-0 bg-black/80 z-[90] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-sm border border-gray-700 flex flex-col max-h-[80vh]">
            <div class="p-3 border-b border-gray-700 flex justify-between items-center bg-gray-900 rounded-t-lg">
                <h3 class="font-bold text-white text-sm">数据模板 (存档) 管理</h3>
                <button onclick="document.getElementById('template-modal').classList.add('hidden')"
                    class="text-gray-400"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 space-y-4 overflow-y-auto">
                <div class="flex gap-2">
                    <input type="text" id="new-template-name" placeholder="新模板名称..."
                        class="flex-1 bg-gray-900 border border-gray-600 rounded px-2 py-1 text-xs text-white">
                    <button onclick="app.createNewTemplate()"
                        class="bg-yellow-600 text-white text-xs px-3 py-1 rounded">创建</button>
                </div>
                <div>
                    <div class="text-xs text-gray-500 mb-2 font-bold">现有存档:</div>
                    <div id="template-list" class="space-y-2"></div>
                </div>
                <div class="pt-4 border-t border-gray-700">
                    <div class="text-xs text-gray-500 mb-2 font-bold flex justify-between">
                        <span>当前模板的自动备份</span>
                        <span class="text-gray-600 font-normal">包括每日备份和清空前备份</span>
                    </div>
                    <div id="backup-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑模态框 -->
    <div id="edit-modal"
        class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div
            class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-sm border border-gray-700 flex flex-col max-h-[90vh]">
            <div class="p-3 border-b border-gray-700 flex justify-between items-center bg-gray-900 rounded-t-lg">
                <h3 class="font-bold text-white text-sm" id="modal-title">信息</h3>
                <button onclick="app.closeModal()"
                    class="text-gray-400 w-6 h-6 flex items-center justify-center rounded hover:bg-gray-700"><i
                        class="fa-solid fa-times"></i></button>
            </div>

            <div class="p-4 overflow-y-auto space-y-4 flex-1">
                <div>
                    <label class="block text-[10px] text-gray-400 mb-1">名称</label>
                    <input type="text" id="marker-name"
                        class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-white focus:border-yellow-500 focus:outline-none text-sm">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-400 mb-2">图标颜色</label>
                    <div class="flex flex-wrap gap-2" id="color-options"></div>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-[10px] text-gray-400">收藏星标</label>
                    <button id="star-toggle"
                        class="flex items-center gap-2 px-3 py-1.5 rounded border border-gray-600 text-xs text-gray-400 hover:text-yellow-400 hover:border-yellow-500 transition"
                        onclick="app.toggleStar()">
                        <i id="star-icon" class="fa-regular fa-star"></i>
                        <span id="star-text">未收藏</span>
                    </button>
                </div>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-[10px] text-gray-400 mb-1">状态</label>
                        <select id="marker-status"
                            class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-white text-xs focus:border-yellow-500 outline-none">
                            <option value="existing">已有</option>
                            <option value="built">已建</option>
                            <option value="missing">未有</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] text-gray-400 mb-1">时间批次 (周)</label>
                        <input type="text" id="marker-date"
                            class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-white text-xs focus:border-yellow-500 outline-none"
                            placeholder="如: 1月07日">
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] text-gray-400 mb-1">备注</label>
                    <textarea id="marker-note" rows="2"
                        class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1.5 text-white focus:border-yellow-500 focus:outline-none text-sm"></textarea>
                </div>
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <label class="text-[10px] text-gray-400">图片 (<span id="img-count-badge"
                                class="text-yellow-500">0</span>)</label>
                        <label
                            class="bg-gray-700 px-2 py-1 rounded text-[10px] cursor-pointer hover:bg-gray-600 border border-gray-600 text-white">
                            <i class="fa-solid fa-plus mr-1"></i>添加
                            <input type="file" id="image-upload" accept="image/*" class="hidden" multiple
                                onchange="app.handleImageUpload(this)">
                        </label>
                    </div>
                    <div id="gallery-container" class="flex gap-2 overflow-x-auto gallery-scroll pb-2 min-h-[60px]">
                    </div>
                </div>
            </div>

            <div class="p-3 border-t border-gray-700 flex justify-between bg-gray-900 rounded-b-lg flex-shrink-0">
                <button onclick="app.deleteMarker()" class="text-red-400 px-3 py-1.5 text-xs hover:text-red-300"
                    id="btn-delete">删除</button>
                <button onclick="app.saveMarker()"
                    class="px-5 py-1.5 text-xs bg-yellow-600 hover:bg-yellow-500 text-white rounded font-bold shadow-lg"
                    id="btn-save">
                    保存
                </button>
            </div>
        </div>
    </div>

    <!-- 大图查看器 -->
    <div id="image-view-modal" class="fixed inset-0 bg-black z-[60] hidden flex items-center justify-center"
        onclick="this.classList.add('hidden')">
        <img id="full-image" src="" class="max-w-full max-h-full object-contain">
    </div>

    <script>
        const MARKER_COLORS = [
            { name: 'red', hex: '#ef4444' },
            { name: 'orange', hex: '#f97316' },
            { name: 'yellow', hex: '#eab308' },
            { name: 'green', hex: '#22c55e' },
            { name: 'cyan', hex: '#06b6d4' },
            { name: 'blue', hex: '#3b82f6' },
            { name: 'purple', hex: '#a855f7' },
            { name: 'pink', hex: '#ec4899' }
        ];

        const STATUS_LABELS = { 'existing': '已有', 'built': '已建', 'missing': '未有' };
        const STATUS_COLORS = {
            'existing': 'bg-green-900 text-green-300 border-green-700',
            'built': 'bg-blue-900 text-blue-300 border-blue-700',
            'missing': 'bg-gray-700 text-gray-400 border-gray-600'
        };

        const MAP_CONFIG = {
            qinghe: { name: "清河", path: "downloads/qinghe", xRange: [2032, 2047], yRange: [2032, 2047], ext: 'jpg' },
            kaifeng: { name: "开封", path: "downloads/kaifeng", xRange: [2024, 2055], yRange: [2024, 2055], ext: 'jpg' },
            hexi: { name: "河西", path: "downloads/hexi", xRange: [1008, 1023], yRange: [1008, 1023], ext: 'jpg' },
            bujianshan: { name: "不见山", path: "downloads/bujianshan", xRange: [1008, 1023], yRange: [1008, 1023], ext: 'jpg' },
            hutuo: { name: "滹沱", path: "downloads/hutuo", xRange: [2032, 2047], yRange: [2032, 2047], ext: 'png' }
        };

        const TILE_SIZE = 256;
        const DB_NAME = 'OfflineMapDB';
        const DB_VERSION = 4;
        const STORE_NAME = 'markers';
        const BACKUP_STORE = 'backups';

        // 全收集模板配置
        const FULL_COLLECTION_CONFIG = {
            id: 'full_collection',
            name: '全收集',
            isRemote: true,
            remoteUrl: 'https://house-offline.pages.dev/全收集.json',
            cacheKey: 'full_collection_cache'
        };

        class MapApp {
            constructor() {
                this.state = {
                    currentMap: 'qinghe',
                    currentTemplate: { id: 'default', name: '默认数据' },
                    templates: [],
                    markers: [],
                    view: { x: 0, y: 0, scale: 0.5 },
                    filters: {
                        status: ['existing', 'built', 'missing'],
                        dates: [],
                        colors: MARKER_COLORS.map(c => c.name),
                        favorites: false // 收藏筛选
                    },
                    filtersInitialized: false,
                    isDragging: false, isPinching: false,
                    lastMouse: { x: 0, y: 0 }, lastPinchDist: 0, startPinchScale: 1,
                    activeMarkerId: null, tempImages: [], tempColor: 'red',
                    isSaving: false, sidebarOpen: false,
                    batchMode: false, batchSelection: new Set(),
                    importCandidate: null,
                    undoStack: [],

                    // 拖拽相关
                    verticalResizing: false,
                    verticalStartY: 0,
                    verticalStartHeight: 0,

                    // 搜索防抖定时器
                    searchDebounceTimer: null,

                    // 聚合开关
                    clusteringEnabled: true,

                    // 全收集同步状态
                    fullCollectionSyncing: false,
                    lastSyncTime: null
                };

                this.db = null;

                this.dom = {
                    sidebar: document.getElementById('sidebar'),
                    topBar: document.getElementById('top-bar'),
                    triggerTop: document.getElementById('trigger-top'),
                    triggerLeft: document.getElementById('trigger-left'),
                    searchWidget: document.getElementById('search-widget'),
                    searchInput: document.getElementById('search-input'),
                    searchScope: document.getElementById('search-scope'),
                    sidebarFilterSection: document.getElementById('sidebar-filter-section'),
                    sidebarVerticalResizer: document.getElementById('sidebar-vertical-resizer'),
                    viewport: document.getElementById('map-viewport'),
                    world: document.getElementById('map-world'),
                    tilesLayer: document.getElementById('tiles-layer'),
                    markersLayer: document.getElementById('markers-layer'),
                    markerList: document.getElementById('marker-list'),
                    statusFilters: document.getElementById('status-filters'),
                    colorFilters: document.getElementById('color-filters'),
                    dateFilters: document.getElementById('date-filters'),
                    dateFilterTitle: document.getElementById('date-filter-title'),
                    favoritesBtn: document.getElementById('filter-favorites-btn'),
                    modal: document.getElementById('edit-modal'),
                    debug: document.getElementById('debug-coords'),
                    loading: document.getElementById('loading-mask'),
                    loadingText: document.getElementById('loading-text'),
                    galleryContainer: document.getElementById('gallery-container'),
                    colorOptions: document.getElementById('color-options'),
                    inputs: {
                        name: document.getElementById('marker-name'),
                        note: document.getElementById('marker-note'),
                        status: document.getElementById('marker-status'),
                        date: document.getElementById('marker-date')
                    },
                    batchBtn: document.getElementById('batch-btn'),
                    undoBtn: document.getElementById('undo-btn'),
                    defaultBottom: document.getElementById('default-bottom-content'),
                    batchBottom: document.getElementById('batch-bottom-content'),
                    importModal: document.getElementById('import-modal'),
                    importNewCount: document.getElementById('import-new-count'),
                    importStatus: document.getElementById('import-status'),
                    importColor: document.getElementById('import-color'),
                    templateSelect: document.getElementById('template-select'),
                    templateList: document.getElementById('template-list'),
                    backupList: document.getElementById('backup-list')
                };
            }

            async init() {
                try {
                    this.loadTemplates();
                    const savedMap = localStorage.getItem('lastMap') || 'qinghe';
                    const mapToLoad = MAP_CONFIG[savedMap] ? savedMap : 'qinghe';
                    this.setupInteraction();
                    this.setupSidebarResizers();
                    this.setupLayoutInteractions(); // 新增：布局交互
                    this.switchMap(mapToLoad, false);
                    document.getElementById('map-select').value = mapToLoad;
                    document.getElementById('map-select').addEventListener('change', (e) => this.switchMap(e.target.value));

                    // 搜索事件绑定 (带防抖优化)
                    this.dom.searchInput.addEventListener('input', () => {
                        clearTimeout(this.state.searchDebounceTimer);
                        this.state.searchDebounceTimer = setTimeout(() => this.renderFilteredContent(), 200);
                    });
                    this.dom.searchScope.addEventListener('change', () => {
                        this.refreshFilters();
                        this.renderFilteredContent();
                    });

                    document.addEventListener('paste', (e) => this.handlePaste(e));
                    if (this.dom.loadingText) this.dom.loadingText.innerText = "正在连接数据库...";
                    await this.initDB();
                    if (this.dom.loadingText) this.dom.loadingText.innerText = "正在加载数据...";

                    // 根据当前模板类型加载数据
                    if (this.state.currentTemplate.id === FULL_COLLECTION_CONFIG.id) {
                        await this.loadFullCollectionData();
                    } else {
                        await this.loadLocalData();
                        await this.checkAndPerformBackup();
                    }

                    this.renderColorFilters();
                    this.updateUndoUI();
                } catch (err) {
                    console.error("Initialization Error:", err);
                    alert(`初始化出错: ${err.message}\n如果一直无法进入，请尝试清空浏览器缓存。`);
                } finally {
                    setTimeout(() => {
                        this.dom.loading.style.opacity = '0';
                        setTimeout(() => this.dom.loading.style.display = 'none', 500);
                        this.resetView();
                    }, 500);
                }
            }

            // === 布局交互逻辑 ===
            setupLayoutInteractions() {
                // 仅在桌面端 (宽屏) 启用悬停交互
                if (window.innerWidth > 768) {
                    // 顶部栏触发
                    this.dom.triggerTop.addEventListener('mouseenter', () => {
                        this.dom.topBar.classList.add('open');
                        this.dom.sidebar.classList.remove('open'); // 互斥
                    });

                    // 顶部栏保持显示
                    this.dom.topBar.addEventListener('mouseenter', () => {
                        this.dom.topBar.classList.add('open');
                    });
                    this.dom.topBar.addEventListener('mouseleave', () => {
                        this.dom.topBar.classList.remove('open');
                    });

                    // 左侧栏触发
                    this.dom.triggerLeft.addEventListener('mouseenter', () => {
                        this.dom.sidebar.classList.add('open');
                        this.dom.topBar.classList.remove('open'); // 互斥
                    });

                    // 左侧栏保持显示
                    this.dom.sidebar.addEventListener('mouseenter', () => {
                        this.dom.sidebar.classList.add('open');
                    });
                    this.dom.sidebar.addEventListener('mouseleave', () => {
                        this.dom.sidebar.classList.remove('open');
                    });
                }
            }

            toggleSearch() {
                // 搜索功能始终展开，点击搜索按钮聚焦输入框
                this.dom.searchInput.focus();
            }

            toggleSidebar(forceState) {
                if (typeof forceState === 'boolean') {
                    this.state.sidebarOpen = forceState;
                } else {
                    this.state.sidebarOpen = !this.state.sidebarOpen;
                }

                const overlay = document.getElementById('sidebar-overlay');
                if (this.state.sidebarOpen) {
                    this.dom.sidebar.classList.add('open');
                    if (window.innerWidth <= 768 && overlay) {
                        overlay.classList.remove('hidden');
                        // Small delay to allow transition
                        requestAnimationFrame(() => overlay.classList.remove('opacity-0'));
                    }
                } else {
                    this.dom.sidebar.classList.remove('open');
                    if (overlay) {
                        overlay.classList.add('opacity-0');
                        setTimeout(() => overlay.classList.add('hidden'), 300);
                    }
                }
            }

            // === 侧边栏拖拽功能 (仅保留垂直) ===
            setupSidebarResizers() {
                const sidebar = this.dom.sidebar;
                const vResizer = this.dom.sidebarVerticalResizer;
                const filterSection = this.dom.sidebarFilterSection;

                // 垂直拖拽 (调整筛选区高度)
                vResizer.addEventListener('mousedown', (e) => {
                    this.state.verticalResizing = true;
                    this.state.verticalStartY = e.clientY;
                    this.state.verticalStartHeight = filterSection.offsetHeight;
                    vResizer.classList.add('resizing');
                    document.body.style.cursor = 'row-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (this.state.verticalResizing) {
                        const deltaY = e.clientY - this.state.verticalStartY;
                        let newHeight = this.state.verticalStartHeight + deltaY;
                        if (newHeight < 100) newHeight = 100;
                        const maxH = sidebar.offsetHeight - 200;
                        if (newHeight > maxH) newHeight = maxH;
                        filterSection.style.height = newHeight + 'px';
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (this.state.verticalResizing) {
                        this.state.verticalResizing = false;
                        vResizer.classList.remove('resizing');
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                    }
                });
            }

            // === 撤回系统 ===
            pushUndo(action) {
                this.state.undoStack.push(action);
                if (this.state.undoStack.length > 20) {
                    this.state.undoStack.shift(); // 限制20步
                }
                this.updateUndoUI();
            }

            async undo() {
                if (this.state.undoStack.length === 0) return;
                const action = this.state.undoStack.pop();

                try {
                    switch (action.type) {
                        case 'DELETE': // 撤回“新增” -> 执行删除
                            await this.deleteFromDB(action.id);
                            this.state.markers = this.state.markers.filter(m => m.id !== action.id);
                            break;
                        case 'ADD': // 撤回“删除” -> 执行新增
                            await this.saveToDB(action.data);
                            this.state.markers.push(action.data);
                            break;
                        case 'UPDATE': // 撤回“修改” -> 恢复旧数据
                            await this.saveToDB(action.data);
                            const idx = this.state.markers.findIndex(m => m.id === action.data.id);
                            if (idx !== -1) this.state.markers[idx] = action.data;
                            break;
                        case 'BATCH_ADD': // 撤回“批量删除/清空” -> 批量恢复
                            const tx = this.db.transaction([STORE_NAME], 'readwrite');
                            const store = tx.objectStore(STORE_NAME);
                            action.data.forEach(m => {
                                store.put(m);
                                this.state.markers.push(m);
                            });
                            await new Promise(resolve => tx.oncomplete = resolve);
                            break;
                        case 'BATCH_UPDATE': // 撤回“批量修改”
                            const tx2 = this.db.transaction([STORE_NAME], 'readwrite');
                            const store2 = tx2.objectStore(STORE_NAME);
                            action.data.forEach(m => {
                                store2.put(m);
                                const idx = this.state.markers.findIndex(x => x.id === m.id);
                                if (idx !== -1) this.state.markers[idx] = m;
                            });
                            await new Promise(resolve => tx2.oncomplete = resolve);
                            break;
                    }
                    this.refreshFilters();
                    this.renderFilteredContent();
                    this.updateUndoUI();

                    // 简单提示
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-4 py-2 rounded text-sm z-[200] fade-out';
                    toast.innerText = '已撤回上一步操作';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 1000);

                } catch (e) {
                    alert('撤回失败: ' + e.message);
                }
            }

            updateUndoUI() {
                if (this.state.undoStack.length === 0) {
                    this.dom.undoBtn.disabled = true;
                    this.dom.undoBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    this.dom.undoBtn.disabled = false;
                    this.dom.undoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            // === 模板系统 ===
            loadTemplates() {
                const stored = localStorage.getItem('app_templates');
                if (stored) {
                    this.state.templates = JSON.parse(stored);
                } else {
                    this.state.templates = [{ id: 'default', name: '默认数据', created: Date.now() }];
                    localStorage.setItem('app_templates', JSON.stringify(this.state.templates));
                }
                const lastTplId = localStorage.getItem('current_template_id');
                // 检查是否是全收集模板
                if (lastTplId === FULL_COLLECTION_CONFIG.id) {
                    this.state.currentTemplate = FULL_COLLECTION_CONFIG;
                } else {
                    const target = this.state.templates.find(t => t.id === lastTplId) || this.state.templates[0];
                    this.state.currentTemplate = target;
                }
                this.updateTemplateSelect();
            }

            updateTemplateSelect() {
                // 普通模板选项
                let html = this.state.templates.map(t =>
                    `<option value="${t.id}" class="bg-gray-800 text-white" ${t.id === this.state.currentTemplate.id ? 'selected' : ''}>${t.name}</option>`
                ).join('');
                // 添加全收集模板选项 (特殊标记)
                const isFullCollection = this.state.currentTemplate.id === FULL_COLLECTION_CONFIG.id;
                html += `<option value="${FULL_COLLECTION_CONFIG.id}" class="bg-yellow-900 text-yellow-300" ${isFullCollection ? 'selected' : ''}>📦 ${FULL_COLLECTION_CONFIG.name}</option>`;
                this.dom.templateSelect.innerHTML = html;
            }

            async switchTemplate(id) {
                if (id === this.state.currentTemplate.id) return;

                // 处理全收集模板
                if (id === FULL_COLLECTION_CONFIG.id) {
                    this.state.currentTemplate = FULL_COLLECTION_CONFIG;
                    localStorage.setItem('current_template_id', id);
                    this.state.markers = [];
                    this.state.batchSelection.clear();
                    this.state.undoStack = [];
                    this.updateUndoUI();
                    this.updateTemplateSelect();
                    if (this.state.batchMode) this.toggleBatchMode();
                    // 加载全收集数据（带增量同步）
                    await this.loadFullCollectionData();
                    return;
                }

                const t = this.state.templates.find(x => x.id === id);
                if (!t) return;
                this.state.currentTemplate = t;
                localStorage.setItem('current_template_id', t.id);
                this.state.markers = [];
                this.state.batchSelection.clear();
                this.state.undoStack = [];
                this.updateUndoUI();
                this.updateTemplateSelect();
                if (this.state.batchMode) this.toggleBatchMode();
                await this.loadLocalData();
                this.refreshFilters();
                this.renderFilteredContent();
                this.checkAndPerformBackup();
            }

            // === 全收集数据加载与增量同步 ===
            async loadFullCollectionData() {
                const cacheKey = FULL_COLLECTION_CONFIG.cacheKey;
                const loadingToast = this.showToast('正在同步全收集数据...', 'loading');

                try {
                    this.state.fullCollectionSyncing = true;

                    // 1. 先加载本地缓存
                    const cachedData = localStorage.getItem(cacheKey);
                    let localData = cachedData ? JSON.parse(cachedData) : [];

                    // 2. 尝试从远程或本地获取最新数据
                    let remoteData = null;

                    // 先尝试远程 Cloudflare
                    try {
                        const remoteUrl = FULL_COLLECTION_CONFIG.remoteUrl;
                        console.log('尝试从远程获取:', remoteUrl);
                        const response = await fetch(remoteUrl, {
                            cache: 'no-store',
                            mode: 'cors'
                        });
                        if (response.ok) {
                            remoteData = await response.json();
                            console.log('远程获取成功, 数据条数:', remoteData.length);
                        }
                    } catch (fetchError) {
                        console.warn('远程获取失败:', fetchError);
                    }

                    // 如果远程失败，尝试本地文件
                    if (!remoteData) {
                        try {
                            console.log('尝试从本地文件获取');
                            const localResponse = await fetch('全收集.json', { cache: 'no-store' });
                            if (localResponse.ok) {
                                remoteData = await localResponse.json();
                                console.log('本地文件获取成功, 数据条数:', remoteData.length);
                            }
                        } catch (localError) {
                            console.warn('本地文件获取失败:', localError);
                        }
                    }

                    // 3. 处理数据
                    if (remoteData && Array.isArray(remoteData)) {
                        const syncResult = this.syncIncrementalUpdates(remoteData, localData);
                        this.state.markers = syncResult.mergedData;

                        // 更新本地缓存
                        localStorage.setItem(cacheKey, JSON.stringify(syncResult.mergedData));
                        this.state.lastSyncTime = new Date().toISOString();

                        loadingToast.remove();
                        this.showToast(`加载完成: ${syncResult.mergedData.length} 条数据`, 'success');
                    } else {
                        // 无法获取任何数据，使用本地缓存
                        this.state.markers = localData;
                        loadingToast.remove();
                        if (localData.length > 0) {
                            this.showToast(`使用缓存: ${localData.length} 条数据`, 'info');
                        } else {
                            this.showToast('无法获取数据，请检查网络或本地文件', 'error');
                        }
                    }

                } catch (error) {
                    console.error('加载全收集数据失败:', error);
                    loadingToast.remove();
                    this.showToast('加载失败: ' + error.message, 'error');
                } finally {
                    this.state.fullCollectionSyncing = false;
                    this.refreshFilters();
                    this.renderFilteredContent();
                }
            }

            // 增量同步算法
            syncIncrementalUpdates(remoteData, localData) {
                const localMap = new Map(localData.map(m => [m.id, m]));
                const mergedData = [];
                let added = 0, updated = 0;

                for (const remote of remoteData) {
                    const local = localMap.get(remote.id);
                    if (!local) {
                        // 新增项目
                        mergedData.push(remote);
                        added++;
                    } else {
                        // 检查是否需要更新（比较 updated_at 时间戳，或整体内容hash）
                        const remoteTime = remote.updated_at ? new Date(remote.updated_at).getTime() : 0;
                        const localTime = local.updated_at ? new Date(local.updated_at).getTime() : 0;

                        if (remoteTime > localTime) {
                            mergedData.push(remote);
                            updated++;
                        } else {
                            mergedData.push(local); // 保留本地版本
                        }
                        localMap.delete(remote.id);
                    }
                }

                // 注意：远程删除的项目不会保留在本地（以远程为准）
                return { mergedData, added, updated };
            }

            // 通用 Toast 提示
            showToast(message, type = 'info') {
                const colors = {
                    loading: 'bg-blue-600',
                    success: 'bg-green-600',
                    error: 'bg-red-600',
                    info: 'bg-gray-700'
                };
                const icons = {
                    loading: '<i class="fa-solid fa-spinner fa-spin mr-2"></i>',
                    success: '<i class="fa-solid fa-check mr-2"></i>',
                    error: '<i class="fa-solid fa-exclamation-circle mr-2"></i>',
                    info: '<i class="fa-solid fa-info-circle mr-2"></i>'
                };

                const toast = document.createElement('div');
                toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-4 py-2 rounded-lg text-sm z-[200] flex items-center shadow-lg`;
                toast.innerHTML = `${icons[type]}${message}`;
                document.body.appendChild(toast);

                if (type !== 'loading') {
                    setTimeout(() => toast.remove(), 2500);
                }
                return toast;
            }

            openTemplateManager() {
                document.getElementById('template-modal').classList.remove('hidden');
                this.renderTemplateList();
                this.renderBackupList();
            }

            renderTemplateList() {
                this.dom.templateList.innerHTML = this.state.templates.map(t => {
                    const isCurrent = t.id === this.state.currentTemplate.id;
                    const isDefault = t.id === 'default';
                    return `
                        <div class="flex items-center justify-between bg-gray-900 p-2 rounded border ${isCurrent ? 'border-yellow-600' : 'border-gray-700'}">
                            <span class="text-xs text-white ${isCurrent ? 'font-bold text-yellow-500' : ''}">${t.name}</span>
                            <div class="flex gap-2">
                                <button onclick="app.renameTemplate('${t.id}')" class="text-blue-400 hover:text-blue-300 text-[10px]"><i class="fa-solid fa-edit"></i></button>
                                ${!isDefault ? `<button onclick="app.deleteTemplate('${t.id}')" class="text-red-500 hover:text-red-300 text-[10px]"><i class="fa-solid fa-trash"></i></button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            createNewTemplate() {
                const nameInput = document.getElementById('new-template-name');
                const name = nameInput.value.trim();
                if (!name) return alert('请输入名称');
                const newTpl = { id: 'tpl_' + Date.now(), name: name, created: Date.now() };
                this.state.templates.push(newTpl);
                localStorage.setItem('app_templates', JSON.stringify(this.state.templates));
                nameInput.value = '';
                this.renderTemplateList();
                this.updateTemplateSelect();
                if (confirm(`模板 "${name}" 创建成功。是否立即切换？`)) {
                    this.switchTemplate(newTpl.id);
                    document.getElementById('template-modal').classList.add('hidden');
                }
            }

            renameTemplate(id) {
                const t = this.state.templates.find(x => x.id === id);
                if (!t) return;
                const newName = prompt("请输入新名称:", t.name);
                if (newName && newName.trim()) {
                    t.name = newName.trim();
                    localStorage.setItem('app_templates', JSON.stringify(this.state.templates));
                    if (this.state.currentTemplate.id === id) this.state.currentTemplate.name = t.name;
                    this.renderTemplateList();
                    this.updateTemplateSelect();
                }
            }

            async deleteTemplate(id) {
                if (id === 'default') return alert('不能删除默认模板');
                if (id === this.state.currentTemplate.id) return alert('无法删除正在使用的模板，请先切换');
                if (!confirm('确定删除此存档？所有相关数据将永久丢失！')) return;
                const tx = this.db.transaction([STORE_NAME, BACKUP_STORE], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const backupStore = tx.objectStore(BACKUP_STORE);
                store.openCursor().onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        if (cursor.value.templateId === id) cursor.delete();
                        cursor.continue();
                    }
                };
                backupStore.openCursor().onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        if (cursor.value.templateId === id) cursor.delete();
                        cursor.continue();
                    }
                };
                this.state.templates = this.state.templates.filter(t => t.id !== id);
                localStorage.setItem('app_templates', JSON.stringify(this.state.templates));
                this.renderTemplateList();
                this.updateTemplateSelect();
            }

            // === 自动备份逻辑 ===
            async checkAndPerformBackup() {
                const tplId = this.state.currentTemplate.id;
                const lastBackupKey = `last_daily_backup_${tplId}`;
                const today = new Date().toLocaleDateString();
                const lastDate = localStorage.getItem(lastBackupKey);
                if (lastDate !== today) {
                    const backupSuccess = await this.performBackup(tplId, 'daily', `${today} (每日自动)`, 2);
                    if (backupSuccess !== false) {
                        localStorage.setItem(lastBackupKey, today);
                    }
                }
            }

            async performBackup(tplId, type, name, limit = 2) {
                if (this.state.markers.length === 0 && type === 'daily') return false;
                if (this.state.markers.length === 0 && type === 'clear') return false;
                const currentDataStr = JSON.stringify(this.state.markers);
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([BACKUP_STORE], 'readwrite');
                    const store = tx.objectStore(BACKUP_STORE);
                    const index = store.index('templateId');
                    const req = index.getAll(tplId);
                    req.onsuccess = () => {
                        const allBackups = req.result || [];
                        const typeBackups = allBackups.filter(b => b.type === type);
                        typeBackups.sort((a, b) => b.timestamp - a.timestamp);
                        if (typeBackups.length > 0) {
                            const lastBackup = typeBackups[0];
                            const lastDataStr = JSON.stringify(lastBackup.data);
                            if (lastDataStr === currentDataStr) {
                                resolve(true); return;
                            }
                        }
                        const backupData = {
                            id: Date.now(),
                            templateId: tplId,
                            type: type,
                            dateStr: name,
                            data: this.state.markers,
                            timestamp: Date.now()
                        };
                        store.add(backupData);
                        if (typeBackups.length >= limit) {
                            const toDelete = typeBackups.slice(limit - 1);
                            toDelete.forEach(b => { try { store.delete(b.id); } catch (e) { } });
                        }
                    };
                    tx.oncomplete = () => resolve(true);
                    tx.onerror = (e) => resolve(false);
                });
            }

            async renderBackupList() {
                const tplId = this.state.currentTemplate.id;
                const tx = this.db.transaction([BACKUP_STORE], 'readonly');
                const index = tx.objectStore(BACKUP_STORE).index('templateId');
                index.getAll(tplId).onsuccess = (e) => {
                    const backups = e.target.result || [];
                    backups.sort((a, b) => b.timestamp - a.timestamp);
                    if (backups.length === 0) {
                        this.dom.backupList.innerHTML = '<div class="text-gray-600 text-[10px] text-center">暂无备份</div>';
                        return;
                    }
                    this.dom.backupList.innerHTML = backups.map(b => {
                        const typeLabel = b.type === 'clear' ? '<span class="text-red-400">[清空前]</span>' : '<span class="text-green-400">[每日]</span>';
                        return `
                        <div class="bg-gray-900 border border-gray-700 p-2 rounded flex justify-between items-center">
                            <div>
                                <div class="text-xs text-yellow-500 font-bold">${typeLabel} ${b.dateStr}</div>
                                <div class="text-[10px] text-gray-500">${new Date(b.timestamp).toLocaleTimeString()} · ${b.data.length} 条数据</div>
                            </div>
                            <button onclick="app.restoreBackup(${b.id})" class="text-[10px] bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded border border-gray-600">恢复</button>
                        </div>
                    `}).join('');
                };
            }

            async restoreBackup(backupId) {
                if (!confirm('确定恢复此备份？当前未保存的修改将丢失。')) return;
                const tx = this.db.transaction([BACKUP_STORE, STORE_NAME], 'readwrite');
                tx.objectStore(BACKUP_STORE).get(backupId).onsuccess = (e) => {
                    const backup = e.target.result;
                    if (!backup) return alert('备份文件损坏');
                    const store = tx.objectStore(STORE_NAME);
                    const tplId = this.state.currentTemplate.id;
                    store.openCursor().onsuccess = (ev) => {
                        const cursor = ev.target.result;
                        if (cursor) {
                            if (cursor.value.templateId === tplId) cursor.delete();
                            cursor.continue();
                        } else {
                            backup.data.forEach(m => store.put(m));
                        }
                    };
                };
                tx.oncomplete = () => { alert('恢复成功，页面将刷新。'); location.reload(); };
            }

            // === 批量与数据操作 ===
            async deleteBatchSelection() {
                if (this.state.batchSelection.size === 0) return alert('未选择任何房产');
                if (!confirm(`确定要永久删除选中的 ${this.state.batchSelection.size} 个房产吗？`)) return;

                // 撤回记录: 批量恢复
                const dataToRestore = this.state.markers.filter(m => this.state.batchSelection.has(m.id));
                this.pushUndo({ type: 'BATCH_ADD', data: JSON.parse(JSON.stringify(dataToRestore)) });

                // 备份
                await this.performBackup(this.state.currentTemplate.id, 'clear', `批量删除前备份 (${new Date().toLocaleTimeString()})`, 2);

                // 优化: 使用单个事务批量删除
                const ids = Array.from(this.state.batchSelection);
                await this.batchDeleteFromDB(ids);
                this.state.markers = this.state.markers.filter(m => !this.state.batchSelection.has(m.id));
                this.state.batchSelection.clear();
                this.updateBatchUI();
                this.refreshFilters();
                this.renderFilteredContent();
            }

            async clearCurrentMapMarkers() {
                const mapName = MAP_CONFIG[this.state.currentMap]?.name || this.state.currentMap;
                if (!confirm(`确定要清空当前地图【${mapName}】的所有数据吗？`)) return;

                // 撤回记录
                const toDel = this.state.markers.filter(m => m.map === this.state.currentMap);
                this.pushUndo({ type: 'BATCH_ADD', data: JSON.parse(JSON.stringify(toDel)) });

                await this.performBackup(this.state.currentTemplate.id, 'clear', `清空当前地图前 (${mapName})`, 2);

                // 优化: 使用单个事务批量删除
                const ids = toDel.map(m => m.id);
                await this.batchDeleteFromDB(ids);
                this.state.markers = this.state.markers.filter(m => m.map !== this.state.currentMap);
                this.refreshFilters();
                this.renderFilteredContent();
            }

            async clearAllMapMarkers() {
                if (!confirm('警告：确定要清空全局（所有地图）的所有数据？\n此操作极度危险！')) return;

                // 撤回记录
                this.pushUndo({ type: 'BATCH_ADD', data: JSON.parse(JSON.stringify(this.state.markers)) });

                await this.performBackup(this.state.currentTemplate.id, 'clear', `清空全局前备份`, 2);

                // 优化: 使用单个事务批量删除
                const ids = this.state.markers.map(m => m.id);
                await this.batchDeleteFromDB(ids);
                this.state.markers = [];
                this.refreshFilters();
                this.renderFilteredContent();
            }

            async executeBatchUpdate() {
                if (this.state.batchSelection.size === 0) return alert('未选择任何房产');
                const newStatus = document.getElementById('batch-status').value;
                const newColor = document.getElementById('batch-color').value;
                if (!newStatus && !newColor) return alert('请选择要修改的状态或颜色');
                if (!confirm(`确定要修改选中的 ${this.state.batchSelection.size} 个房产吗？`)) return;

                // 撤回记录: 记录修改前的状态
                const oldData = this.state.markers.filter(m => this.state.batchSelection.has(m.id));
                this.pushUndo({ type: 'BATCH_UPDATE', data: JSON.parse(JSON.stringify(oldData)) });

                const tx = this.db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                this.state.markers.forEach(m => {
                    if (this.state.batchSelection.has(m.id)) {
                        let changed = false;
                        if (newStatus && m.status !== newStatus) { m.status = newStatus; changed = true; }
                        if (newColor && m.color !== newColor) { m.color = newColor; changed = true; }
                        if (changed) { m.updated_at = new Date().toISOString(); store.put(m); }
                    }
                });
                tx.oncomplete = () => {
                    this.toggleBatchMode();
                    this.refreshFilters();
                    this.renderFilteredContent();
                };
            }

            async saveMarker() {
                if (this.state.isSaving) return;
                this.state.isSaving = true;
                const btn = document.getElementById('btn-save');
                const oldText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                try {
                    const data = {
                        id: this.state.activeMarkerId || crypto.randomUUID(),
                        map: this.state.currentMap,
                        templateId: this.state.currentTemplate.id,
                        name: this.dom.inputs.name.value.trim() || '未命名',
                        note: this.dom.inputs.note.value.trim(),
                        status: this.dom.inputs.status.value,
                        batchDate: this.dom.inputs.date.value.trim(),
                        color: this.state.tempColor,
                        images: this.state.tempImages,
                        isStarred: this.state.tempIsStarred || false, // 使用编辑时的星标状态
                        updated_at: new Date().toISOString()
                    };

                    if (this.state.activeMarkerId) {
                        const old = this.state.markers.find(m => m.id === data.id);
                        this.pushUndo({ type: 'UPDATE', data: JSON.parse(JSON.stringify(old)) });

                        data.x = old.x; data.y = old.y;
                        const idx = this.state.markers.findIndex(m => m.id === data.id);
                        this.state.markers[idx] = data;
                    } else {
                        this.pushUndo({ type: 'DELETE', id: data.id });

                        data.x = this.state.pendingCoords.x;
                        data.y = this.state.pendingCoords.y;
                        this.state.markers.push(data);
                    }

                    await this.saveToDB(data);
                    this.refreshFilters();
                    this.renderFilteredContent();
                    this.closeModal();
                } catch (e) { alert('保存失败: ' + e.message); }
                finally { this.state.isSaving = false; btn.innerHTML = oldText; }
            }

            async deleteMarker() {
                if (!this.state.activeMarkerId) return;
                if (!confirm('确定删除？')) return;
                try {
                    const target = this.state.markers.find(m => m.id === this.state.activeMarkerId);
                    // 撤回记录
                    this.pushUndo({ type: 'ADD', data: JSON.parse(JSON.stringify(target)) });

                    await this.deleteFromDB(this.state.activeMarkerId);
                    this.state.markers = this.state.markers.filter(m => m.id !== this.state.activeMarkerId);
                    this.refreshFilters();
                    this.renderFilteredContent();
                    this.closeModal();
                } catch (e) { alert("删除失败: " + e.message); }
            }

            toggleBatchMode() {
                this.state.batchMode = !this.state.batchMode;
                this.state.batchSelection.clear();
                if (this.state.batchMode) {
                    this.dom.sidebar.classList.add('batch-mode');
                    this.dom.batchBtn.innerText = "退出";
                    this.dom.batchBtn.classList.replace('text-gray-300', 'text-yellow-500');
                    this.dom.batchBtn.classList.replace('border-gray-600', 'border-yellow-500');
                    this.dom.defaultBottom.classList.add('hidden');
                    this.dom.batchBottom.classList.remove('hidden');
                    this.dom.batchBottom.classList.add('flex');
                } else {
                    this.dom.sidebar.classList.remove('batch-mode');
                    this.dom.batchBtn.innerText = "批量";
                    this.dom.batchBtn.classList.replace('text-yellow-500', 'text-gray-300');
                    this.dom.batchBtn.classList.replace('border-yellow-500', 'border-gray-600');
                    this.dom.defaultBottom.classList.remove('hidden');
                    this.dom.batchBottom.classList.add('hidden');
                    this.dom.batchBottom.classList.remove('flex');
                }
                this.updateBatchUI();
                this.renderFilteredContent();
            }
            toggleBatchItem(id) {
                if (this.state.batchSelection.has(id)) this.state.batchSelection.delete(id);
                else this.state.batchSelection.add(id);
                this.updateBatchUI();
            }

            selectAllBatch() {
                const currentIds = Array.from(document.querySelectorAll('.batch-checkbox')).map(el => el.getAttribute('data-id'));
                if (currentIds.length === 0) return;
                const allSelected = currentIds.every(id => this.state.batchSelection.has(id));
                if (allSelected) {
                    currentIds.forEach(id => this.state.batchSelection.delete(id));
                } else {
                    currentIds.forEach(id => this.state.batchSelection.add(id));
                }
                this.renderFilteredContent();
                this.updateBatchUI();
            }

            invertBatchSelection() {
                const currentIds = Array.from(document.querySelectorAll('.batch-checkbox')).map(el => el.getAttribute('data-id'));
                if (currentIds.length === 0) return;
                currentIds.forEach(id => {
                    if (this.state.batchSelection.has(id)) this.state.batchSelection.delete(id);
                    else this.state.batchSelection.add(id);
                });
                this.renderFilteredContent();
                this.updateBatchUI();
            }

            updateBatchUI() { document.getElementById('batch-count').innerText = this.state.batchSelection.size; }
            exportBatchSelection() {
                const selectedIds = Array.from(this.state.batchSelection);
                if (selectedIds.length === 0) return alert('请先在列表中选中房产');
                const dataToExport = this.state.markers.filter(m => selectedIds.includes(m.id));
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = `selected_export_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url); // 优化: 释放内存
            }

            initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = (e) => reject(e.target.error);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        let store;
                        if (!db.objectStoreNames.contains(STORE_NAME)) store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        else store = request.transaction.objectStore(STORE_NAME);
                        if (!store.indexNames.contains('templateId')) store.createIndex('templateId', 'templateId', { unique: false });
                        if (!db.objectStoreNames.contains(BACKUP_STORE)) {
                            const backupStore = db.createObjectStore(BACKUP_STORE, { keyPath: 'id' });
                            backupStore.createIndex('templateId', 'templateId', { unique: false });
                        }
                    };
                    request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                });
            }

            async loadLocalData() {
                try {
                    const tx = this.db.transaction([STORE_NAME], 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const tplId = this.state.currentTemplate.id;
                    const req = store.getAll();
                    return new Promise((resolve) => {
                        req.onsuccess = (e) => {
                            const allData = e.target.result || [];
                            this.state.markers = allData.filter(m => {
                                const mTi = m.templateId || 'default';
                                return mTi === tplId;
                            });
                            this.refreshFilters();
                            this.renderFilteredContent();
                            resolve();
                        };
                    });
                } catch (e) { console.error("Load failed", e); }
            }

            async saveToDB(item) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([STORE_NAME], 'readwrite');
                    tx.objectStore(STORE_NAME).put(item);
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e.target.error);
                });
            }

            async deleteFromDB(id) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([STORE_NAME], 'readwrite');
                    tx.objectStore(STORE_NAME).delete(id);
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e);
                });
            }

            // 优化: 单事务批量删除
            async batchDeleteFromDB(ids) {
                if (ids.length === 0) return;
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([STORE_NAME], 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    ids.forEach(id => store.delete(id));
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e);
                });
            }


            exportData(withImages = true) {
                if (this.state.markers.length === 0) return alert('当前模板无数据');
                // 根据参数决定是否包含图片
                const dataToExport = withImages
                    ? this.state.markers
                    : this.state.markers.map(m => {
                        const { images, ...rest } = m;
                        return rest;
                    });
                const suffix = withImages ? '' : '_无图';
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = `backup_${this.state.currentTemplate.name}${suffix}_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            initImport(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!Array.isArray(data)) throw new Error('格式错误');
                        const existingIds = new Set(this.state.markers.map(item => item.id));
                        const newItems = data.filter(item => !existingIds.has(item.id));
                        if (newItems.length === 0) {
                            alert('当前模板中已包含文件中所有ID，无需导入。');
                            input.value = '';
                            return;
                        }
                        this.state.importCandidate = data;
                        this.dom.importNewCount.innerText = newItems.length;
                        this.dom.importModal.classList.remove('hidden');
                    } catch (err) { alert('文件解析失败: ' + err.message); input.value = ''; }
                };
                reader.readAsText(file);
                this.lastImportInput = input;
            }

            confirmImport() {
                const data = this.state.importCandidate;
                if (!data) return;
                const defaultStatus = this.dom.importStatus.value;
                const defaultColor = this.dom.importColor.value;
                const tx = this.db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const existingIds = new Set(this.state.markers.map(item => item.id));
                let addedCount = 0;
                data.forEach(m => {
                    if (existingIds.has(m.id)) return;
                    if (defaultColor !== '') m.color = defaultColor;
                    if (defaultStatus !== '') m.status = defaultStatus;
                    if (!m.images && m.image) m.images = [m.image];
                    m.templateId = this.state.currentTemplate.id;
                    store.put(m);
                    addedCount++;
                });
                tx.oncomplete = () => {
                    this.dom.importModal.classList.add('hidden');
                    alert(`导入完成\n已添加 ${addedCount} 条数据到 "${this.state.currentTemplate.name}"`);
                    location.reload();
                };
                if (this.lastImportInput) this.lastImportInput.value = '';
                this.state.importCandidate = null;
            }

            switchMap(mapKey, autoReset = true) {
                this.state.currentMap = mapKey;
                localStorage.setItem('lastMap', mapKey);
                const config = MAP_CONFIG[mapKey];
                this.dom.world.style.width = ((config.xRange[1] - config.xRange[0] + 1) * TILE_SIZE) + 'px';
                this.dom.world.style.height = ((config.yRange[1] - config.yRange[0] + 1) * TILE_SIZE) + 'px';
                this.renderTiles(config);
                this.refreshFilters();
                this.renderFilteredContent();
                if (autoReset) requestAnimationFrame(() => this.resetView());
            }

            renderTiles(config) {
                this.dom.tilesLayer.innerHTML = '';
                const frag = document.createDocumentFragment();
                for (let x = config.xRange[0]; x <= config.xRange[1]; x++) {
                    for (let y = config.yRange[0]; y <= config.yRange[1]; y++) {
                        const tile = document.createElement('div');
                        tile.className = 'map-tile';
                        tile.style.left = (x - config.xRange[0]) * TILE_SIZE + 'px';
                        tile.style.top = (y - config.yRange[0]) * TILE_SIZE + 'px';
                        const img = document.createElement('img');
                        img.src = `${config.path}/${y}_${x}.${config.ext}`;
                        tile.appendChild(img);
                        frag.appendChild(tile);
                    }
                }
                this.dom.tilesLayer.appendChild(frag);
            }

            refreshFilters() {
                const scope = this.dom.searchScope.value;
                let sourceData;
                if (scope === 'global') {
                    sourceData = this.state.markers;
                    this.dom.dateFilterTitle.innerText = "时间/批次 (全局)";
                } else {
                    sourceData = this.state.markers.filter(m => m.map === this.state.currentMap);
                    this.dom.dateFilterTitle.innerText = "时间/批次";
                }
                const dateCounts = {};
                sourceData.forEach(m => {
                    const d = m.batchDate || "未分类";
                    dateCounts[d] = (dateCounts[d] || 0) + 1;
                });
                const sortedDates = Object.keys(dateCounts).sort().reverse();
                if (!this.state.filtersInitialized) {
                    this.state.filters.dates = sortedDates;
                    this.state.filtersInitialized = true;
                }
                this.renderFilterUI(sortedDates, dateCounts);
            }

            renderColorFilters() {
                this.dom.colorFilters.innerHTML = MARKER_COLORS.map(c => {
                    const isActive = this.state.filters.colors.includes(c.name);
                    return `<div class="filter-color-dot ${isActive ? 'active' : ''}" style="background-color: ${c.hex};" onclick="app.toggleColorFilter('${c.name}')"></div>`;
                }).join('');
            }

            toggleColorFilter(colorName) {
                const colors = this.state.filters.colors;
                const idx = colors.indexOf(colorName);
                if (idx !== -1) colors.splice(idx, 1); else colors.push(colorName);
                this.renderColorFilters();
                this.renderFilteredContent();
            }

            renderFilterUI(availableDates, dateCounts) {
                const statusHtml = ['existing', 'built', 'missing'].map(status => {
                    const isChecked = this.state.filters.status.includes(status);
                    const label = STATUS_LABELS[status];
                    const activeClass = isChecked ? 'bg-yellow-600 text-white border-yellow-500' : 'bg-gray-700 text-gray-400 border-gray-600 hover:bg-gray-600';
                    return `<button onclick="app.toggleStatusFilter('${status}')" class="flex-1 py-1 rounded border transition-colors ${activeClass}">${label}</button>`;
                }).join('');
                this.dom.statusFilters.innerHTML = statusHtml;

                if (availableDates.length === 0) {
                    this.dom.dateFilters.innerHTML = '<div class="text-gray-500 text-center py-2 text-xs">无日期数据</div>';
                } else {
                    this.dom.dateFilters.innerHTML = availableDates.map(date => {
                        const isChecked = this.state.filters.dates.includes(date);
                        const count = dateCounts[date] || 0;
                        return `
                            <label class="flex items-center w-full bg-gray-800/50 hover:bg-gray-700/50 p-1.5 rounded cursor-pointer select-none transition-colors border border-transparent hover:border-gray-600">
                                <input type="checkbox" class="filter-checkbox rounded bg-gray-900 border-gray-600 text-yellow-500 focus:ring-0 w-3.5 h-3.5 mr-2 flex-shrink-0" value="${date}" ${isChecked ? 'checked' : ''} onchange="app.toggleDateFilter('${date}')">
                                <span class="text-gray-300 text-xs truncate flex-1">${date} <span class="text-gray-500 ml-1">(${count})</span></span>
                            </label>`;
                    }).join('');
                }
            }

            // 新增：切换收藏筛选
            toggleFavoriteFilter() {
                this.state.filters.favorites = !this.state.filters.favorites;
                const btn = this.dom.favoritesBtn;
                if (this.state.filters.favorites) {
                    btn.classList.add('text-yellow-400', 'border-yellow-500');
                    btn.classList.remove('text-gray-400', 'border-gray-600');
                } else {
                    btn.classList.remove('text-yellow-400', 'border-yellow-500');
                    btn.classList.add('text-gray-400', 'border-gray-600');
                }
                this.renderFilteredContent();
            }

            // 切换聚合功能开关
            toggleClustering() {
                this.state.clusteringEnabled = !this.state.clusteringEnabled;
                const btn = document.getElementById('cluster-toggle-btn');
                if (this.state.clusteringEnabled) {
                    btn.classList.add('text-yellow-400', 'border-yellow-500');
                    btn.classList.remove('text-gray-400', 'border-gray-600');
                } else {
                    btn.classList.remove('text-yellow-400', 'border-yellow-500');
                    btn.classList.add('text-gray-400', 'border-gray-600');
                }
                this.renderFilteredContent();
            }

            toggleStatusFilter(status) {
                const idx = this.state.filters.status.indexOf(status);
                if (idx === -1) this.state.filters.status.push(status);
                else this.state.filters.status.splice(idx, 1);
                this.refreshFilters(); this.renderFilteredContent();
            }

            toggleDateFilter(date) {
                const idx = this.state.filters.dates.indexOf(date);
                if (idx === -1) this.state.filters.dates.push(date);
                else this.state.filters.dates.splice(idx, 1);
                this.renderFilteredContent();
            }

            selectAllDates() {
                const checkboxes = Array.from(this.dom.dateFilters.querySelectorAll('input'));
                const allDates = checkboxes.map(c => c.value);
                if (allDates.length === 0) return;
                const allSelected = allDates.every(d => this.state.filters.dates.includes(d));
                if (allSelected) {
                    this.state.filters.dates = this.state.filters.dates.filter(d => !allDates.includes(d));
                } else {
                    const toAdd = allDates.filter(d => !this.state.filters.dates.includes(d));
                    this.state.filters.dates = [...this.state.filters.dates, ...toAdd];
                }
                this.refreshFilters();
                this.renderFilteredContent();
            }

            invertDates() {
                const checkboxes = Array.from(this.dom.dateFilters.querySelectorAll('input'));
                const allDates = checkboxes.map(c => c.value);
                if (allDates.length === 0) return;
                const currentSet = new Set(this.state.filters.dates);
                allDates.forEach(d => {
                    if (currentSet.has(d)) currentSet.delete(d);
                    else currentSet.add(d);
                });
                this.state.filters.dates = Array.from(currentSet);
                this.refreshFilters();
                this.renderFilteredContent();
            }

            renderFilteredContent() {
                const term = this.dom.searchInput.value.toLowerCase();
                const scope = this.dom.searchScope.value;
                const baseCondition = (m) => {
                    const mStatus = m.status || 'missing';
                    if (!this.state.filters.status.includes(mStatus)) return false;
                    const mDate = m.batchDate || "未分类";
                    if (!this.state.filters.dates.includes(mDate)) return false;
                    const mColor = m.color || 'red';
                    if (!this.state.filters.colors.includes(mColor)) return false;

                    // 新增：收藏筛选逻辑
                    if (this.state.filters.favorites && !m.isStarred) return false;

                    if (term) {
                        const inName = m.name.toLowerCase().includes(term);
                        const inDate = m.batchDate && m.batchDate.toLowerCase().includes(term);
                        if (!inName && !inDate) return false;
                    }

                    return true;
                };
                const mapData = this.state.markers.filter(m => m.map === this.state.currentMap && baseCondition(m));
                const listData = this.state.markers.filter(m => {
                    if (scope === 'global') return baseCondition(m);
                    else return m.map === this.state.currentMap && baseCondition(m);
                });
                this.renderMarkers(mapData);
                this.renderList(listData);
            }

            // 获取当前视口在地图坐标系的边界
            getVisibleBounds() {
                const { x, y, scale } = this.state.view;
                const vpW = this.dom.viewport.clientWidth;
                const vpH = this.dom.viewport.clientHeight;
                const buffer = 512; // 2个瓦片的缓冲区

                return {
                    left: (-x / scale) - buffer,
                    top: (-y / scale) - buffer,
                    right: (vpW - x) / scale + buffer,
                    bottom: (vpH - y) / scale + buffer
                };
            }

            // 聚合算法：将相邻标点合并
            clusterMarkers(markers) {
                const scale = this.state.view.scale;
                // 聚合开关关闭时不聚合，或缩放比例 >= 0.6 时不聚合
                if (!this.state.clusteringEnabled || scale >= 0.6) {
                    return markers.map(m => ({ ...m, isCluster: false, clusterCount: 1, clusterMarkers: [m] }));
                }

                // 计算聚合格子大小（屏幕上约80px的距离）
                const gridSize = 80 / scale;
                const clusters = new Map();

                markers.forEach(m => {
                    const gridX = Math.floor(m.x / gridSize);
                    const gridY = Math.floor(m.y / gridSize);
                    const key = `${gridX}_${gridY}`;

                    if (!clusters.has(key)) {
                        clusters.set(key, { markers: [], sumX: 0, sumY: 0 });
                    }
                    const cluster = clusters.get(key);
                    cluster.markers.push(m);
                    cluster.sumX += m.x;
                    cluster.sumY += m.y;
                });

                const result = [];
                clusters.forEach((cluster) => {
                    const count = cluster.markers.length;
                    const centerX = cluster.sumX / count;
                    const centerY = cluster.sumY / count;

                    if (count === 1) {
                        result.push({ ...cluster.markers[0], isCluster: false, clusterCount: 1, clusterMarkers: cluster.markers });
                    } else {
                        // 合并为聚合点
                        result.push({
                            id: 'cluster_' + cluster.markers.map(m => m.id).join('_'),
                            x: centerX,
                            y: centerY,
                            name: `${count}个标点`,
                            color: cluster.markers[0].color,
                            isCluster: true,
                            clusterCount: count,
                            clusterMarkers: cluster.markers
                        });
                    }
                });

                return result;
            }

            renderMarkers(markers) {
                this.dom.markersLayer.innerHTML = '';

                // 1. 视口裁剪
                const bounds = this.getVisibleBounds();
                const visibleMarkers = markers.filter(m =>
                    m.x >= bounds.left && m.x <= bounds.right &&
                    m.y >= bounds.top && m.y <= bounds.bottom
                );

                // 2. 聚合处理
                const processedMarkers = this.clusterMarkers(visibleMarkers);

                // 3. 渲染
                processedMarkers.forEach(m => {
                    const el = document.createElement('div');
                    el.className = 'marker marker-clickable';
                    el.style.left = m.x + 'px';
                    el.style.top = m.y + 'px';
                    el.style.pointerEvents = 'auto';

                    if (m.isCluster) {
                        // 聚合标点渲染
                        el.innerHTML = `
                            <div class="marker-icon">
                                <div class="flex flex-col items-center relative">
                                    <div class="text-[10px] bg-yellow-600 text-white px-2 py-0.5 rounded-full mb-0.5 whitespace-nowrap shadow-lg select-none font-bold">
                                        (${m.clusterCount})
                                    </div>
                                    <i class="fa-solid fa-layer-group text-4xl drop-shadow-lg text-yellow-500"></i>
                                </div>
                            </div>
                        `;
                    } else {
                        // 普通标点渲染
                        const hasImage = m.images && m.images.length > 0;
                        let previewHtml = hasImage ? `<div class="marker-preview-box"><img src="${m.images[0]}" alt="预览"></div>` : '';
                        const statusColor = m.status === 'existing' ? '#22c55e' : (m.status === 'built' ? '#3b82f6' : '#9ca3af');
                        const starBadge = m.isStarred ? `<i class="fa-solid fa-star text-yellow-400 text-[10px] drop-shadow-md absolute -top-2 -right-2 z-20"></i>` : '';

                        el.innerHTML = `
                            <div class="marker-icon">
                                ${previewHtml}
                                <div class="flex flex-col items-center relative">
                                    ${starBadge}
                                    <div class="text-[10px] bg-black/80 text-white px-1.5 py-0.5 rounded mb-0.5 whitespace-nowrap backdrop-blur-sm border border-gray-600 shadow-md select-none flex items-center gap-1">
                                        <span class="w-1.5 h-1.5 rounded-full" style="background:${statusColor}"></span>
                                        ${m.name}
                                    </div>
                                    <i class="fa-solid fa-location-dot text-3xl drop-shadow-md filter transition-colors duration-200" style="color: ${MARKER_COLORS.find(c => c.name === m.color)?.hex || '#ef4444'}"></i>
                                </div>
                            </div>
                        `;
                    }

                    // 改进的触摸处理：区分点击和拖动，允许拖动时穿透
                    let touchStartData = null;
                    let isDragging = false;

                    el.addEventListener('touchstart', (e) => {
                        touchStartData = {
                            x: e.touches[0].clientX,
                            y: e.touches[0].clientY,
                            time: Date.now()
                        };
                        isDragging = false;

                        // 同步触发地图层的拖动开始（穿透实现）
                        this.state.isDragging = true;
                        this.state.lastMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    }, { passive: true });

                    el.addEventListener('touchmove', (e) => {
                        if (!touchStartData) return;
                        const touch = e.touches[0];
                        const dx = Math.abs(touch.clientX - touchStartData.x);
                        const dy = Math.abs(touch.clientY - touchStartData.y);

                        // 移动超过8px认为是拖动
                        if (dx > 8 || dy > 8) {
                            isDragging = true;
                            // 禁用此标点的 pointer-events 让后续事件穿透
                            el.style.pointerEvents = 'none';

                            // 手动更新地图位置
                            const moveDx = touch.clientX - this.state.lastMouse.x;
                            const moveDy = touch.clientY - this.state.lastMouse.y;
                            this.state.view.x += moveDx;
                            this.state.view.y += moveDy;
                            this.state.lastMouse = { x: touch.clientX, y: touch.clientY };
                            this.updateTransform();
                        }
                    }, { passive: true });

                    el.addEventListener('touchend', () => {
                        // 延迟恢复 pointer-events
                        setTimeout(() => {
                            el.style.pointerEvents = 'auto';
                        }, 100);
                    }, { passive: true });

                    el.addEventListener('touchend', (e) => {
                        if (!touchStartData || isDragging) {
                            touchStartData = null;
                            return;
                        }

                        const touch = e.changedTouches[0];
                        const dx = Math.abs(touch.clientX - touchStartData.x);
                        const dy = Math.abs(touch.clientY - touchStartData.y);
                        const dt = Date.now() - touchStartData.time;

                        // 只有移动距离小于15px且时间小于300ms才算点击
                        if (dx < 15 && dy < 15 && dt < 300) {
                            e.stopPropagation();
                            e.preventDefault();

                            if (m.isCluster) {
                                // 点击聚合点：放大到该区域
                                this.zoomToCluster(m);
                            } else {
                                this.openEditModal(m.id);
                            }
                        }

                        touchStartData = null;
                    }, { passive: false });

                    // 桌面端点击事件
                    el.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (m.isCluster) {
                            this.zoomToCluster(m);
                        } else {
                            this.openEditModal(m.id);
                        }
                    });

                    this.dom.markersLayer.appendChild(el);
                });
            }

            // 点击聚合点时放大到该区域
            zoomToCluster(cluster) {
                const targetScale = Math.min(this.state.view.scale * 2, 1.5);
                const vpW = this.dom.viewport.clientWidth;
                const vpH = this.dom.viewport.clientHeight;

                this.state.view = {
                    x: vpW / 2 - cluster.x * targetScale,
                    y: vpH / 2 - cluster.y * targetScale,
                    scale: targetScale
                };
                this.updateTransform(true);
                this.renderFilteredContent();
            }

            // 新增：切换单个标点的收藏状态
            async toggleStar(id) {
                const m = this.state.markers.find(item => item.id === id);
                if (!m) return;

                // 记录状态用于撤回
                this.pushUndo({ type: 'UPDATE', data: JSON.parse(JSON.stringify(m)) });

                m.isStarred = !m.isStarred;
                await this.saveToDB(m);
                this.renderFilteredContent();
                // 刷新地图以显示/隐藏小星星标记
                this.renderMarkers(this.state.markers.filter(item => item.map === this.state.currentMap));
            }

            renderList(markers) {
                const list = this.dom.markerList;
                list.innerHTML = '';
                document.getElementById('marker-count').innerText = `${markers.length} 个房产`;

                const nameCounts = {};
                this.state.markers.forEach(item => {
                    const n = item.name.trim();
                    nameCounts[n] = (nameCounts[n] || 0) + 1;
                });

                if (!markers.length) {
                    list.innerHTML = '<div class="text-center text-gray-500 text-xs mt-8">无符合条件的标点</div>';
                    return;
                }
                markers.forEach(m => {
                    const statusKey = m.status || 'missing';
                    const statusClass = STATUS_COLORS[statusKey];
                    const statusText = STATUS_LABELS[statusKey];
                    const isOtherMap = m.map !== this.state.currentMap;
                    const mapName = MAP_CONFIG[m.map]?.name || m.map;
                    const isSelected = this.state.batchSelection.has(m.id);

                    const isDuplicate = nameCounts[m.name.trim()] > 1;
                    const duplicateIcon = isDuplicate ? '<i class="fa-solid fa-circle-exclamation text-red-500 ml-1" title="名称重复"></i>' : '';

                    // 新增：星标图标逻辑
                    const starClass = m.isStarred ? 'fa-solid text-yellow-400' : 'fa-regular text-gray-600 hover:text-yellow-400';

                    const div = document.createElement('div');
                    div.className = `bg-gray-800 p-2.5 rounded cursor-pointer border-l-2 hover:bg-gray-700 transition-colors select-none group ${isOtherMap ? 'opacity-80' : ''} flex items-start gap-2`;
                    div.style.borderLeftColor = MARKER_COLORS.find(c => c.name === m.color)?.hex || '#ef4444';
                    const checkboxHtml = `
                        <input type="checkbox" class="batch-checkbox flex-shrink-0 mt-1 w-4 h-4 rounded bg-gray-900 border-gray-600 text-yellow-600 focus:ring-0" 
                            data-id="${m.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); app.toggleBatchItem('${m.id}')">
                    `;
                    div.innerHTML = `
                        ${checkboxHtml}
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-bold text-sm text-gray-200 group-hover:text-yellow-500 transition-colors truncate mr-2">
                                    ${m.name}${duplicateIcon}
                                </span>
                                <div class="flex gap-1 flex-shrink-0 items-center">
                                    <button onclick="event.stopPropagation(); app.toggleStar('${m.id}')" class="mr-1 focus:outline-none p-1 -m-1">
                                        <i class="${starClass} fa-star transition-colors"></i>
                                    </button>
                                    ${isOtherMap ? `<span class="text-[10px] px-1.5 py-0.5 rounded border border-gray-600 bg-gray-900 text-yellow-500">${mapName}</span>` : ''}
                                    <span class="text-[10px] px-1.5 py-0.5 rounded border ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-[10px] text-gray-400">
                                <span class="bg-gray-900 px-1 rounded">${m.batchDate || '未分类'}</span>
                                ${m.images && m.images.length ? `<i class="fa-solid fa-image text-gray-500"></i>` : ''}
                            </div>
                            ${m.note ? `<div class="text-[10px] text-gray-500 truncate mt-1">${m.note}</div>` : ''}
                        </div>
                    `;
                    div.onclick = () => {
                        if (this.state.batchMode) {
                            this.toggleBatchItem(m.id);
                            const cb = div.querySelector('input[type="checkbox"]');
                            if (cb) cb.checked = !cb.checked;
                        } else {
                            this.focusMarker(m);
                        }
                    };
                    div.ondblclick = (e) => {
                        if (this.state.batchMode) return;
                        e.stopPropagation();
                        this.openEditModal(m.id);
                    };
                    list.appendChild(div);
                });
            }

            setupInteraction() {
                const vp = this.dom.viewport;
                const getDist = (t1, t2) => Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
                vp.addEventListener('touchstart', (e) => {
                    if (e.target.closest('.marker-clickable')) return;
                    if (e.touches.length === 1) {
                        this.state.isDragging = true;
                        this.state.isPinching = false;
                        this.state.lastMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    } else if (e.touches.length === 2) {
                        this.state.isDragging = false;
                        this.state.isPinching = true;
                        this.state.lastPinchDist = getDist(e.touches[0], e.touches[1]);
                        this.state.startPinchScale = this.state.view.scale;
                        e.preventDefault();
                    }
                }, { passive: false });
                vp.addEventListener('touchmove', (e) => {
                    if (this.state.isDragging && e.touches.length === 1) {
                        e.preventDefault();
                        const dx = e.touches[0].clientX - this.state.lastMouse.x;
                        const dy = e.touches[0].clientY - this.state.lastMouse.y;
                        this.state.view.x += dx;
                        this.state.view.y += dy;
                        this.state.lastMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                        this.updateTransform();
                    } else if (this.state.isPinching && e.touches.length === 2) {
                        e.preventDefault();
                        const dist = getDist(e.touches[0], e.touches[1]);
                        if (dist > 10 && this.state.lastPinchDist > 0) {
                            const rect = vp.getBoundingClientRect();
                            const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
                            const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
                            const zoomFactor = dist / this.state.lastPinchDist;
                            const newScale = Math.min(Math.max(0.1, this.state.view.scale * zoomFactor), 4.0);
                            this.state.view.x = cx - (cx - this.state.view.x) * (newScale / this.state.view.scale);
                            this.state.view.y = cy - (cy - this.state.view.y) * (newScale / this.state.view.scale);
                            this.state.view.scale = newScale;
                            this.state.lastPinchDist = dist;
                            this.updateTransform();
                        }
                    }
                }, { passive: false });
                const handleEnd = () => { this.state.isDragging = false; this.state.isPinching = false; };
                vp.addEventListener('touchend', handleEnd);
                vp.addEventListener('touchcancel', handleEnd);
                vp.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.marker-clickable')) return;
                    e.preventDefault();
                    this.state.isDragging = true;
                    this.state.lastMouse = { x: e.clientX, y: e.clientY };
                    vp.style.cursor = 'grabbing';
                });
                window.addEventListener('mousemove', (e) => {
                    if (this.state.isDragging) {
                        e.preventDefault();
                        this.state.view.x += e.clientX - this.state.lastMouse.x;
                        this.state.view.y += e.clientY - this.state.lastMouse.y;
                        this.state.lastMouse = { x: e.clientX, y: e.clientY };
                        this.updateTransform();
                    }
                });
                window.addEventListener('mouseup', () => { this.state.isDragging = false; vp.style.cursor = 'grab'; });
                vp.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = -e.deltaY * 0.001;
                    const newScale = Math.min(Math.max(0.1, this.state.view.scale + delta), 4.0);
                    const rect = vp.getBoundingClientRect();
                    const mx = e.clientX - rect.left;
                    const my = e.clientY - rect.top;
                    this.state.view.x = mx - (mx - this.state.view.x) * (newScale / this.state.view.scale);
                    this.state.view.y = my - (my - this.state.view.y) * (newScale / this.state.view.scale);
                    this.state.view.scale = newScale;
                    this.updateTransform();
                }, { passive: false });
                let startTap = { x: 0, y: 0, t: 0 };
                this.dom.world.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) startTap = { x: e.touches[0].clientX, y: e.touches[0].clientY, t: Date.now() };
                });
                this.dom.world.addEventListener('touchend', (e) => {
                    const t = e.changedTouches[0];
                    if (Date.now() - startTap.t < 300 && Math.hypot(t.clientX - startTap.x, t.clientY - startTap.y) < 10) {
                        this.handleMapClick(t.clientX, t.clientY, e.target);
                    }
                });
                let isClick = true;
                vp.addEventListener('mousedown', () => isClick = true);
                vp.addEventListener('mousemove', () => isClick = false);
                this.dom.world.addEventListener('click', (e) => {
                    if (isClick) this.handleMapClick(e.clientX, e.clientY, e.target);
                });
            }

            handleMapClick(cx, cy, target) {
                if (target.closest('.marker-clickable')) return;
                // close sidebars if open
                if (this.dom.sidebar.classList.contains('open')) {
                    this.dom.sidebar.classList.remove('open');
                    return;
                }
                if (this.dom.topBar.classList.contains('open')) {
                    this.dom.topBar.classList.remove('open');
                    return;
                }

                const rect = this.dom.viewport.getBoundingClientRect();
                const wx = (cx - rect.left - this.state.view.x) / this.state.view.scale;
                const wy = (cy - rect.top - this.state.view.y) / this.state.view.scale;
                if (wx >= 0 && wy >= 0 && wx <= this.dom.world.offsetWidth && wy <= this.dom.world.offsetHeight) {
                    this.openCreateModal(wx, wy);
                }
            }

            updateTransform(forceRepaint = false) {
                const { x, y, scale } = this.state.view;
                const prevScale = parseFloat(this.dom.world.style.getPropertyValue('--map-scale')) || 1;

                this.dom.world.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
                this.dom.world.style.setProperty('--map-scale', scale);

                // 缩放比例变化时强制重绘以清除GPU缓存
                if (forceRepaint || Math.abs(scale - prevScale) > 0.01) {
                    requestAnimationFrame(() => {
                        this.dom.tilesLayer.style.opacity = '0.999';
                        requestAnimationFrame(() => {
                            this.dom.tilesLayer.style.opacity = '1';
                        });
                    });
                }

                // 防抖更新可见标点（视口裁剪）
                clearTimeout(this._viewportUpdateTimer);
                this._viewportUpdateTimer = setTimeout(() => {
                    this.renderFilteredContent();
                }, 150);

                if (this.dom.debug) this.dom.debug.innerText = `${Math.round(x)},${Math.round(y)} x${scale.toFixed(2)}`;
            }

            resetView(w, h) {
                if (!w) w = parseInt(this.dom.world.style.width) || 1000;
                if (!h) h = parseInt(this.dom.world.style.height) || 1000;
                const scale = Math.min(window.innerWidth / w, window.innerHeight / h) * 0.9;
                this.state.view = { x: (window.innerWidth - w * scale) / 2, y: (window.innerHeight - h * scale) / 2, scale };
                this.updateTransform();
            }

            focusMarker(m) {
                if (m.map !== this.state.currentMap) {
                    document.getElementById('map-select').value = m.map;
                    this.switchMap(m.map, false);
                }
                const s = 1.0;
                const vpW = this.dom.viewport.clientWidth;
                const vpH = this.dom.viewport.clientHeight;
                this.state.view = { x: vpW / 2 - m.x * s, y: vpH / 2 - m.y * s, scale: s };
                this.updateTransform();
            }

            openCreateModal(x, y) {
                this.state.activeMarkerId = null;
                this.state.tempImages = [];
                this.state.tempColor = 'red';
                this.state.pendingCoords = { x, y };
                const now = new Date();
                const defaultDate = `${now.getMonth() + 1}月${now.getDate().toString().padStart(2, '0')}日`;
                this.updateModalUI('新建房产', '', '', 'existing', defaultDate);
                this.dom.modal.classList.remove('hidden');
                if (window.innerWidth > 768) setTimeout(() => this.dom.inputs.name.focus(), 50);
            }

            openEditModal(id) {
                const m = this.state.markers.find(x => x.id === id);
                if (!m) return;
                this.state.activeMarkerId = id;
                this.state.tempImages = [...(m.images || [])];
                this.state.tempColor = m.color || 'red';
                this.state.tempIsStarred = m.isStarred || false;
                this.updateModalUI('编辑房产', m.name, m.note, m.status, m.batchDate, m.isStarred);
                this.dom.modal.classList.remove('hidden');
            }

            updateModalUI(title, name, note, status, date, isStarred) {
                document.getElementById('modal-title').innerText = title;
                this.dom.inputs.name.value = name;
                this.dom.inputs.note.value = note || '';
                this.dom.inputs.status.value = status || 'missing';
                this.dom.inputs.date.value = date || '';
                document.getElementById('btn-delete').style.display = this.state.activeMarkerId ? 'block' : 'none';

                // 更新星标UI
                this.state.tempIsStarred = isStarred || false;
                const starIcon = document.getElementById('star-icon');
                const starText = document.getElementById('star-text');
                if (this.state.tempIsStarred) {
                    starIcon.className = 'fa-solid fa-star text-yellow-400';
                    starText.textContent = '已收藏';
                } else {
                    starIcon.className = 'fa-regular fa-star';
                    starText.textContent = '未收藏';
                }

                this.renderColorSelector();
                this.renderGallery();
            }

            toggleStar() {
                this.state.tempIsStarred = !this.state.tempIsStarred;
                const starIcon = document.getElementById('star-icon');
                const starText = document.getElementById('star-text');
                if (this.state.tempIsStarred) {
                    starIcon.className = 'fa-solid fa-star text-yellow-400';
                    starText.textContent = '已收藏';
                } else {
                    starIcon.className = 'fa-regular fa-star';
                    starText.textContent = '未收藏';
                }
            }

            renderColorSelector() {
                this.dom.colorOptions.innerHTML = MARKER_COLORS.map(c => `
                    <div class="color-dot ${this.state.tempColor === c.name ? 'selected' : ''}" style="background:${c.hex}" onclick="app.selectColor('${c.name}')"></div>
                `).join('');
            }
            selectColor(c) { this.state.tempColor = c; this.renderColorSelector(); }

            renderGallery() {
                const container = this.dom.galleryContainer;
                document.getElementById('img-count-badge').innerText = this.state.tempImages.length;
                if (!this.state.tempImages.length) {
                    container.innerHTML = '<div class="text-gray-600 text-[10px] w-full text-center py-3 border border-dashed border-gray-700 rounded">无图片</div>';
                    return;
                }
                container.innerHTML = this.state.tempImages.map((src, i) => `
                    <div class="relative w-16 h-16 flex-shrink-0 group">
                        <img src="${src}" class="w-full h-full object-cover rounded border border-gray-600 cursor-pointer" onclick="app.viewFullImage('${src}')">
                        <button onclick="app.removeImage(${i})" class="absolute -top-1.5 -right-1.5 bg-red-600 text-white rounded-full w-4 h-4 flex items-center justify-center shadow-lg hover:bg-red-500 text-[10px]">&times;</button>
                    </div>
                `).join('');
            }

            // ... saveMarker and deleteMarker have been updated above ...

            closeModal() { this.dom.modal.classList.add('hidden'); }
            handleImageUpload(input) { Array.from(input.files).forEach(f => this.processImage(f)); input.value = ''; }
            handlePaste(e) {
                if (!this.dom.modal.classList.contains('hidden')) {
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let item of items) if (item.kind === 'file') this.processImage(item.getAsFile());
                }
            }
            processImage(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxW = 800;
                        let w = img.width, h = img.height;
                        if (w > maxW) { h *= maxW / w; w = maxW; }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        this.state.tempImages.push(canvas.toDataURL('image/jpeg', 0.7));
                        this.renderGallery();
                    };
                };
                reader.readAsDataURL(file);
            }
            removeImage(i) { this.state.tempImages.splice(i, 1); this.renderGallery(); }
            viewFullImage(src) { document.getElementById('full-image').src = src; document.getElementById('image-view-modal').classList.remove('hidden'); }
        }

        class TouchGestureHandler {
            constructor(app) {
                this.app = app;
                this.startX = 0;
                this.startY = 0;
                this.threshold = 50; // min distance for swipe
                this.edgeThreshold = 30; // only swipe from edge

                document.addEventListener('touchstart', e => this.handleStart(e), { passive: false });
                document.addEventListener('touchend', e => this.handleEnd(e), { passive: false });
            }

            handleStart(e) {
                if (e.touches.length !== 1) return;
                this.startX = e.touches[0].clientX;
                this.startY = e.touches[0].clientY;
            }

            handleEnd(e) {
                if (e.changedTouches.length !== 1) return;
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                const dist = endX - this.startX;
                const absDistY = Math.abs(endY - this.startY);

                // Swipe Right (Open Sidebar) - Only from left edge
                if (dist > this.threshold && absDistY < 100 && this.startX < this.edgeThreshold) {
                    if (!this.app.state.sidebarOpen) this.app.toggleSidebar(true);
                }

                // Swipe Left (Close Sidebar)
                if (dist < -this.threshold && absDistY < 100) {
                    if (this.app.state.sidebarOpen) this.app.toggleSidebar(false);
                }
            }
        }

        window.addEventListener('load', () => {
            window.app = new MapApp();
            window.app.init();
            new TouchGestureHandler(window.app);
        });
    </script>
</body>

</html>